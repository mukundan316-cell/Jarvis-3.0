# JARVIS IntelliAgent 3.0 - Deployment Guide

Complete guide for deploying JARVIS from Git to Replit or other hosting platforms.

## Table of Contents

1. [Replit Deployment](#replit-deployment)
2. [Git Setup & Push](#git-setup--push)
3. [Restoration on New Replit Account](#restoration-on-new-replit-account)
4. [Database Migration](#database-migration)
5. [Environment Configuration](#environment-configuration)
6. [Verification Steps](#verification-steps)
7. [External Hosting](#external-hosting)
8. [Troubleshooting](#troubleshooting)

---

## Replit Deployment

### Method 1: Import from GitHub (Recommended)

#### Step 1: Prepare Your GitHub Repository

1. **Push your code to GitHub**:
   ```bash
   git init
   git add .
   git commit -m "Initial commit: JARVIS IntelliAgent 3.0"
   git remote add origin https://github.com/your-username/jarvis-intelliagent.git
   git push -u origin main
   ```

2. **Verify `.gitignore` is correct**:
   ```bash
   cat .gitignore
   # Should exclude: node_modules, dist, .env, database_export.sql, etc.
   ```

3. **Ensure required files are committed**:
   ```bash
   git ls-files | grep -E '\.(replit|package.json|tsconfig.json|drizzle.config.ts)'
   # Should show: .replit, package.json, tsconfig.json, drizzle.config.ts
   ```

#### Step 2: Import to Replit

**Rapid Import (Public Repos)**:
```
https://replit.com/github.com/your-username/jarvis-intelliagent
```
- Paste this URL in your browser
- Automatic import process starts

**Guided Import (Public & Private Repos)**:
1. Go to https://replit.com/import
2. Select "GitHub" as import source
3. Connect GitHub account (authorize Replit)
4. Select `jarvis-intelliagent` repository
5. Click "Import"
6. Configure privacy settings
7. Click "Import" to start

#### Step 3: Replit Auto-Configuration

Replit will automatically:
- ✅ Detect Node.js 20 (from `.replit` modules)
- ✅ Install dependencies (npm install)
- ✅ Provision PostgreSQL database
- ✅ Set up port forwarding (5000 → 80)
- ✅ Configure workflows

#### Step 4: Configure Secrets

In Replit Secrets tool:
1. Click "Secrets" in left sidebar
2. Add required secrets:

   ```env
   # Database (Auto-provided by Replit)
   DATABASE_URL=<auto-generated>

   # GitHub OAuth (You provide)
   GITHUB_CLIENT_ID=your_github_client_id
   GITHUB_CLIENT_SECRET=your_github_client_secret
   
   # Session Security (Generate random string)
   SESSION_SECRET=<generate with: openssl rand -base64 32>
   
   # Optional: External Services
   SENDGRID_API_KEY=your_sendgrid_key
   OPENAI_API_KEY=your_openai_key
   GA_TRACKING_ID=your_ga_tracking_id
   ```

#### Step 5: Update GitHub OAuth Callback

1. Go to https://github.com/settings/developers
2. Edit your OAuth App
3. Update callback URL to your Replit domain:
   ```
   https://<your-repl-name>.<your-username>.repl.co/api/callback
   ```
4. Save changes

#### Step 6: Push Database Schema

In Replit Shell:
```bash
npm run db:push
```

If you get a data-loss warning (fresh database):
```bash
npm run db:push -- --force
```

#### Step 7: Start the Application

Click the "Run" button or use Shell:
```bash
npm run dev
```

Application will be available at:
- Development: `https://<your-repl-name>.<your-username>.repl.co`

---

## Git Setup & Push

### Initial Git Setup (If Not Already Done)

1. **Initialize Git repository**:
   ```bash
   git init
   ```

2. **Configure Git** (if first time):
   ```bash
   git config --global user.name "Your Name"
   git config --global user.email "your.email@example.com"
   ```

3. **Add remote repository**:
   ```bash
   git remote add origin https://github.com/your-username/jarvis-intelliagent.git
   ```

4. **Verify remote**:
   ```bash
   git remote -v
   # origin  https://github.com/your-username/jarvis-intelliagent.git (fetch)
   # origin  https://github.com/your-username/jarvis-intelliagent.git (push)
   ```

### Committing Changes

1. **Check status**:
   ```bash
   git status
   ```

2. **Stage files**:
   ```bash
   git add .
   # Or specific files:
   git add server/routes.ts client/src/components/NewComponent.tsx
   ```

3. **Commit with message**:
   ```bash
   git commit -m "feat: add new feature description"
   ```

4. **Push to GitHub**:
   ```bash
   git push origin main
   ```

### Using Replit Git Pane (Visual Interface)

1. **Open Git pane**: Tools → Git
2. **Review changes**: See modified files with diffs
3. **Stage files**: Check boxes next to files to include
4. **Commit**: Enter message and click "Commit"
5. **Push**: Click "Push" to send to GitHub

---

## Restoration on New Replit Account

### Complete Restoration Checklist

When restoring JARVIS on a **new Replit account** from Git:

#### ✅ Step 1: Import Repository

Follow **Method 1: Import from GitHub** above.

#### ✅ Step 2: Verify File Structure

After import, verify all files exist:
```bash
ls -la
# Should show:
# - .replit
# - package.json
# - tsconfig.json
# - vite.config.ts
# - drizzle.config.ts
# - client/ server/ shared/ directories
```

#### ✅ Step 3: Install Dependencies

Replit auto-installs, but verify:
```bash
npm install
```

Check for errors in console.

#### ✅ Step 4: Configure Database

**Option A: Use Replit PostgreSQL (Recommended)**
- Database auto-provisions
- DATABASE_URL automatically set in Secrets
- No manual setup needed

**Option B: Use External Database (Neon, Supabase, etc.)**
1. Create database on external service
2. Copy connection string
3. Add to Replit Secrets: `DATABASE_URL=postgresql://...`

#### ✅ Step 5: Set Up GitHub OAuth

**Create New OAuth App** (or use existing):
1. Go to https://github.com/settings/developers
2. Click "New OAuth App"
3. Fill in:
   - **Name**: JARVIS IntelliAgent 3.0
   - **Homepage**: `https://<new-repl-name>.<username>.repl.co`
   - **Callback**: `https://<new-repl-name>.<username>.repl.co/api/callback`
4. Copy Client ID and Secret
5. Add to Replit Secrets

#### ✅ Step 6: Configure All Secrets

Add to Replit Secrets:
```env
DATABASE_URL=<from Replit or external DB>
GITHUB_CLIENT_ID=<from step 5>
GITHUB_CLIENT_SECRET=<from step 5>
SESSION_SECRET=<generate new: openssl rand -base64 32>
SENDGRID_API_KEY=<optional>
OPENAI_API_KEY=<optional>
GA_TRACKING_ID=<optional>
```

#### ✅ Step 7: Restore Database Schema & Data

**Option A: Fresh Schema (No Data)**
```bash
npm run db:push -- --force
```

**Option B: Restore with Data**

1. **Download database export** from original Replit/storage:
   - `database_export.sql` (complete with data)

2. **Upload to new Replit**:
   - Drag file to Replit file tree
   - Or use Shell: `wget <url-to-sql-file>`

3. **Restore database**:
   ```bash
   psql $DATABASE_URL < database_export.sql
   ```

4. **Verify tables exist**:
   ```bash
   psql $DATABASE_URL -c "\dt"
   # Should show 50+ tables
   ```

#### ✅ Step 8: Verify Configuration Files

**Check .replit**:
```bash
cat .replit
# Verify:
# - modules = ["nodejs-20", "web", "postgresql-16"]
# - run = "npm run dev"
# - deployment settings correct
```

**Check package.json scripts**:
```bash
cat package.json | grep -A 5 "scripts"
# Verify:
# - "dev": "NODE_ENV=development tsx server/index.ts"
# - "build": correct
# - "db:push": "drizzle-kit push"
```

#### ✅ Step 9: Start Application

Click "Run" button or:
```bash
npm run dev
```

Watch for errors in console.

#### ✅ Step 10: Verify Application Works

See **[Verification Steps](#verification-steps)** below.

---

## Database Migration

### Migrating Database Between Environments

#### Export Database (From Original Replit)

**Full export (schema + data)**:
```bash
pg_dump $DATABASE_URL --no-owner --no-acl --clean --if-exists > database_export.sql
```

**Schema only**:
```bash
pg_dump $DATABASE_URL --schema-only --no-owner --no-acl > database_schema_only.sql
```

**Compress for download**:
```bash
gzip database_export.sql
# Downloads as database_export.sql.gz
```

#### Import Database (To New Replit)

**From full export**:
```bash
psql $DATABASE_URL < database_export.sql
```

**From schema only + seed data**:
```bash
# Import schema
psql $DATABASE_URL < database_schema_only.sql

# Run application (seeds will populate)
npm run dev
```

**Verify import**:
```bash
psql $DATABASE_URL -c "SELECT COUNT(*) FROM agents;"
psql $DATABASE_URL -c "SELECT COUNT(*) FROM users;"
psql $DATABASE_URL -c "\dt"  # List all tables
```

---

## Environment Configuration

### Required Environment Variables

| Variable | Required | Source | Purpose |
|----------|----------|--------|---------|
| `DATABASE_URL` | ✅ Yes | Replit auto-provides or external DB | PostgreSQL connection |
| `GITHUB_CLIENT_ID` | ✅ Yes | GitHub OAuth App | Authentication |
| `GITHUB_CLIENT_SECRET` | ✅ Yes | GitHub OAuth App | Authentication |
| `SESSION_SECRET` | ✅ Yes | Generate random | Session encryption |
| `SENDGRID_API_KEY` | ❌ Optional | SendGrid account | Email functionality |
| `OPENAI_API_KEY` | ❌ Optional | OpenAI account | AI features |
| `GA_TRACKING_ID` | ❌ Optional | Google Analytics | Analytics tracking |

### Generating SESSION_SECRET

```bash
# Using OpenSSL (recommended)
openssl rand -base64 32

# Using Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

# Using Python
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

### Setting Secrets in Replit

**Via Secrets Tool**:
1. Click "Secrets" in left sidebar
2. Click "New secret"
3. Enter key (e.g., `GITHUB_CLIENT_ID`)
4. Enter value
5. Click "Add secret"

**Via .env file (Not Recommended)**:
- .env files are excluded from Git (.gitignore)
- Use Replit Secrets for better security
- .env files don't persist across Replit rebuilds

---

## Verification Steps

### Post-Deployment Verification Checklist

#### 1. Server Health
```bash
curl http://localhost:5000/api/health
# Should return: { "status": "ok" }
```

#### 2. Database Connection
```bash
psql $DATABASE_URL -c "SELECT COUNT(*) FROM agents;"
# Should return count > 0
```

#### 3. Authentication
1. Open application URL
2. Click "Login with GitHub"
3. Should redirect to GitHub
4. Authorize app
5. Should redirect back and be logged in

#### 4. Persona Dashboard
1. Should see persona selection
2. Switch to "Admin" persona
3. Dashboard should load with KPIs
4. No console errors

#### 5. Agent Directory
1. Navigate to "Agent Directory" tab
2. Should see agents grouped by layer
3. Filter by business function
4. Search for agents

#### 6. Real-Time Execution
1. Execute a command (e.g., "Review Submissions")
2. Agent execution popup should appear
3. Should see 6-layer progression
4. WebSocket status: "Connected"
5. Steps should progress automatically

#### 7. Voice Integration
1. Click microphone icon
2. Grant browser permissions
3. Speak a command
4. Should transcribe and execute

#### 8. Configuration System
1. Check ConfigService loads
   ```bash
   curl http://localhost:5000/api/config/registry
   # Should return config keys
   ```

#### 9. Database Integrity
```bash
# Check referential integrity
psql $DATABASE_URL -c "
  SELECT COUNT(*) FROM agents;
  SELECT COUNT(*) FROM agent_versions;
  SELECT COUNT(*) FROM config_registry;
  SELECT COUNT(*) FROM role_personas;
"
```

#### 10. Build Process
```bash
npm run build
# Should complete without errors
# Check dist/ folder created
ls -la dist/
```

---

## External Hosting

### Deploying to Non-Replit Platforms

#### Vercel

**Prerequisites**: Vercel account, Vercel CLI

1. **Install Vercel CLI**:
   ```bash
   npm i -g vercel
   ```

2. **Configure vercel.json**:
   ```json
   {
     "version": 2,
     "builds": [
       {
         "src": "server/index.ts",
         "use": "@vercel/node"
       },
       {
         "src": "package.json",
         "use": "@vercel/static-build",
         "config": { "distDir": "dist/public" }
       }
     ],
     "routes": [
       { "src": "/api/(.*)", "dest": "server/index.ts" },
       { "src": "/(.*)", "dest": "dist/public/$1" }
     ]
   }
   ```

3. **Add build script to package.json**:
   ```json
   "scripts": {
     "vercel-build": "npm run build"
   }
   ```

4. **Deploy**:
   ```bash
   vercel --prod
   ```

5. **Add environment variables** in Vercel dashboard

#### Railway

**Prerequisites**: Railway account

1. **Install Railway CLI**:
   ```bash
   npm i -g @railway/cli
   ```

2. **Initialize Railway**:
   ```bash
   railway init
   ```

3. **Add PostgreSQL database**:
   ```bash
   railway add --plugin postgresql
   ```

4. **Set environment variables**:
   ```bash
   railway variables set GITHUB_CLIENT_ID=xxx
   railway variables set GITHUB_CLIENT_SECRET=xxx
   railway variables set SESSION_SECRET=xxx
   ```

5. **Deploy**:
   ```bash
   railway up
   ```

#### DigitalOcean App Platform

1. **Connect GitHub repo** via DigitalOcean dashboard
2. **Configure build settings**:
   - Build command: `npm run build`
   - Run command: `npm run start`
3. **Add PostgreSQL database** in dashboard
4. **Set environment variables** in dashboard
5. **Deploy**

---

## Troubleshooting

### Common Issues & Solutions

#### 1. "Module not found" errors

**Problem**: Dependencies not installed

**Solution**:
```bash
rm -rf node_modules package-lock.json
npm install
```

#### 2. "Cannot connect to database"

**Problem**: DATABASE_URL not set or incorrect

**Solution**:
```bash
# Verify secret exists
echo $DATABASE_URL

# Test connection
psql $DATABASE_URL -c "SELECT 1;"

# Reset in Replit Secrets if needed
```

#### 3. "GitHub OAuth redirect_uri_mismatch"

**Problem**: Callback URL doesn't match GitHub OAuth app

**Solution**:
1. Get current Replit URL: `https://<repl-name>.<username>.repl.co`
2. Update GitHub OAuth app callback: `https://<repl-name>.<username>.repl.co/api/callback`
3. Ensure exact match (no trailing slash)

#### 4. "Port 5000 already in use"

**Problem**: Another process using port 5000

**Solution**:
```bash
# Find and kill process
lsof -ti:5000 | xargs kill -9

# Or change port in .replit
```

#### 5. "WebSocket connection failed"

**Problem**: WebSocket endpoint not accessible

**Solution**:
- Check server logs for errors
- Verify port forwarding in .replit
- Test WebSocket: `wscat -c ws://localhost:5000/api/agent-executions/ws`

#### 6. "Database migration failed"

**Problem**: Schema conflicts or missing tables

**Solution**:
```bash
# Force push schema (DESTRUCTIVE - loses data)
npm run db:push -- --force

# Or restore from backup
psql $DATABASE_URL < database_export.sql
```

#### 7. "Build fails with TypeScript errors"

**Problem**: Type checking errors

**Solution**:
```bash
# Check types
npm run check

# Fix errors shown
# Then rebuild
npm run build
```

#### 8. "Missing environment variable"

**Problem**: Required secret not set

**Solution**:
1. Check .env.example for required variables
2. Add missing secrets in Replit Secrets
3. Restart application

#### 9. "Authentication session expires immediately"

**Problem**: SESSION_SECRET changed or not set

**Solution**:
- Generate new SESSION_SECRET
- Add to Replit Secrets
- Clear browser cookies
- Log in again

#### 10. "Agents not appearing in directory"

**Problem**: Database not seeded or empty

**Solution**:
```bash
# Check agents exist
psql $DATABASE_URL -c "SELECT COUNT(*) FROM agents;"

# If 0, restore from backup or run seed scripts
psql $DATABASE_URL < database_export.sql
```

---

## Production Deployment

### Pre-Deployment Checklist

- [ ] All environment variables configured
- [ ] GitHub OAuth callback URL updated
- [ ] Database backup created
- [ ] Build succeeds locally: `npm run build`
- [ ] TypeScript check passes: `npm run check`
- [ ] Git committed and pushed
- [ ] .gitignore excludes sensitive files
- [ ] Secrets not in code (grep for API keys)

### Production Configuration

In `.replit` deployment section:
```toml
[deployment]
deploymentTarget = "autoscale"  # or "static"
build = ["npm", "run", "build"]
run = ["npm", "run", "start"]
```

### Monitoring

After deployment, monitor:
- Server logs (Replit console or hosting platform)
- Database connections
- API response times
- WebSocket connections
- Error rates

### Rollback Plan

If deployment fails:
1. **Revert Git commit**: `git revert HEAD`
2. **Push to remote**: `git push origin main`
3. **Restore database**: `psql $DATABASE_URL < database_backup.sql`
4. **Restart application**

---

## Additional Resources

- **[README.md](./README.md)** - Project overview
- **[ARCHITECTURE.md](./ARCHITECTURE.md)** - Architecture details
- **[DATABASE_SETUP.md](./DATABASE_SETUP.md)** - Database documentation
- **[shared/schema.ts](./shared/schema.ts)** - Complete database schema
- **Replit Docs**: https://docs.replit.com
- **GitHub OAuth Docs**: https://docs.github.com/en/developers/apps/oauth-apps

---

**Last Updated**: 2025-11-12  
**Version**: 3.0
